<!doctype html><html lang=en><head><title>Cloudflare with LetsEncrypt SSL Certificates + Apache's ProxyPass ::
CC's Sink — A spot for my thoughts, ramblings, and occasionally advice</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="So, you want to use LetsEncrypt to generate a free SSL certificate for your site behind Cloudflare and Apache (acting as a ReverseProxy). After many hours of research and tweaking, I got this setup to work. Here I will document my process for you to use. In the end, your setup will look something like this: User &amp;lt;-(SSL)-&amp;gt; Cloudflare &amp;lt;-(SSL)-&amp;gt; Apache &amp;lt;&amp;ndash;&amp;gt; Your Webapp (not SSL). This guide assumes you have a site already setup without SSL."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/posts/2016-cloudflare-letsencrypt/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/img/favicon.png><link href=/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Cloudflare with LetsEncrypt SSL Certificates + Apache's ProxyPass"><meta name=twitter:description content="So, you want to use LetsEncrypt to generate a free SSL certificate for your site behind Cloudflare and Apache (acting as a ReverseProxy). After many hours of research and tweaking, I got this setup to work. Here I will document my process for you to use. In the end, your setup will look something like this: User <-(SSL)-> Cloudflare <-(SSL)-> Apache <&ndash;> Your Webapp (not SSL). This guide assumes you have a site already setup without SSL."><meta property="og:title" content="Cloudflare with LetsEncrypt SSL Certificates + Apache's ProxyPass"><meta property="og:description" content="So, you want to use LetsEncrypt to generate a free SSL certificate for your site behind Cloudflare and Apache (acting as a ReverseProxy). After many hours of research and tweaking, I got this setup to work. Here I will document my process for you to use. In the end, your setup will look something like this: User <-(SSL)-> Cloudflare <-(SSL)-> Apache <&ndash;> Your Webapp (not SSL). This guide assumes you have a site already setup without SSL."><meta property="og:type" content="article"><meta property="og:url" content="/posts/2016-cloudflare-letsencrypt/"><meta property="article:published_time" content="2016-11-08T14:53:00+00:00"><meta property="article:modified_time" content="2016-11-08T14:53:00+00:00"><meta property="og:site_name" content="CC's Sink"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>CC's Sink</span>
<span class=logo__cursor></span></a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/showcase>Showcase</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/showcase>Showcase</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41C32.4934 41 41 32.4934 41 22 41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Cloudflare with LetsEncrypt SSL Certificates + Apache&rsquo;s ProxyPass</h1><div class=post-meta><span class=post-date>2016-11-08</span>
<span class=post-read-time>— 4 min read</span></div><div class=post-content><p>So, you want to use <a href=https://letsencrypt.org/>LetsEncrypt</a> to generate a free SSL certificate for your site behind Cloudflare and Apache (acting as a ReverseProxy). After many hours of research and tweaking, I got this setup to work. Here I will document my process for you to use. In the end, your setup will look something like this: <em>User &lt;-(SSL)-> Cloudflare &lt;-(SSL)-> Apache &lt;&ndash;> Your Webapp (not SSL)</em>. This guide assumes you have a site already setup without SSL. I am using Ubuntu 16.04 for my setup, but the process should be similar for other OSes.</p><h2 id=getting-started>Getting Started</h2><p>Before we do anything, we need to install LetsEncrypt. LetsEncrypt reccomends <a href=https://certbot.eff.org/>Certbot</a> as their client. Unless you know what you are doing, you should use this. Follow the instructions on their site to install the Certbot client. After Certbot is installed, you should install the apache mod <em>mod_cloudflare</em>. It isn&rsquo;t required, but is good in any setup invloving Cloudflare, as it resolves IPs to their actual source, not Cloudflare&rsquo;s IPs. Follow the instructions on <a href=https://www.cloudflare.com/technical-resources/#mod_cloudflare>Cloudflare&rsquo;s site</a>, and run <code>sudo a2enmod cloudflare</code> to ensure it is enabled. Finally, make a backup of the the site configs you will be changing. It is unlikely something will go wrong, but just in case we need to roll back we should have one.</p><h2 id=custom-config-patch>Custom Config Patch</h2><p>Now that Certbot/LE is installed, we will continue on with the setup. By default, apache passes all traffic to the backend application when using ProxyPass. We need to add an exception to this rule by installing and including a custom config. <em>If you aren&rsquo;t using ProxyPass, skip this step</em>. Make a new file in <code>/etc/apache2/conf-avaliable/letsencrypt-proxypass-fix.conf</code>, and paste the following into it:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml># From https://github.com/certbot/certbot/issues/2164
<span style=color:#f92672>&lt;IfModule</span> <span style=color:#960050;background-color:#1e0010>mod_proxy.c</span><span style=color:#f92672>&gt;</span> # If Proxy is installed
    ProxyPass &#34;/.well-known/acme-challenge&#34; &#34;!&#34; # Do not proxy the acme verification
<span style=color:#f92672>&lt;/IfModule&gt;</span>
Alias /.well-known/acme-challenge /var/www/html/.well-known/acme-challenge # Send all requests for the acme verification to this location
<span style=color:#f92672>&lt;Directory</span> <span style=color:#960050;background-color:#1e0010>&#34;/var/www/html/.well-known/acme-challenge&#34;</span><span style=color:#f92672>&gt;</span> # Allow any requests for it
    Options None
    AllowOverride None
    Require all granted
    AddDefaultCharset off
<span style=color:#f92672>&lt;/Directory&gt;</span>
</code></pre></div><p>Save the file, and quit. For now this isn&rsquo;t activated, but we will be including it in the site configuration file next.</p><h2 id=generating-the-certificate>Generating the Certificate</h2><p>Now that most of the prep work is finished, we can get to actually generating the certificate. Include the line <code>Include /etc/apache2/conf-available/letsencrypt-proxypass-fix.conf</code> in the site&rsquo;s config, and reload apache. Now, run <code>certbot certonly --webroot --webroot-path /var/www/html/ --renew-by-default -d YOUR.DOMAIN.HERE</code>. Answer the questions, and assuming everything was done correctly, you will get a message saying that the certificate was generated successfully, and will expire in 90 days. Whoopee, you have an SSL certificate! However, even though you were issued an SSL certificate, apache doesn&rsquo;t know about it, and is still only listening for non-secure connections. We need to install the certificate for apache to use.</p><h2 id=installing-the-certificate>Installing the Certificate</h2><p>Now that you have generated the certificate, you need to install it to apache. Open your site&rsquo;s config, and edit it to look something like the following. Note, some applications require extra flags and steps, so please follow their documentation as well; this is a minimal config. Also, don&rsquo;t forget to include any other configurations you had from your old config!</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#f92672>&lt;VirtualHost</span> <span style=color:#960050;background-color:#1e0010>*:80</span><span style=color:#f92672>&gt;</span>
ServerName YOUR.DOMAIN.HERE
Redirect permanent / https://YOUR.DOMAIN.HERE/ # Redirect all nonsecure requests to use HTTPS
<span style=color:#f92672>&lt;/VirtualHost&gt;</span>

<span style=color:#f92672>&lt;VirtualHost</span> <span style=color:#960050;background-color:#1e0010>*:443</span><span style=color:#f92672>&gt;</span>
ServerName YOUR.DOMAIN.HERE

SSLProxyEngine On
SSLCertificateFile /etc/letsencrypt/live/YOUR.DOMAIN.HERE/cert.pem
SSLCertificateKeyFile /etc/letsencrypt/live/YOUR.DOMAIN.HERE/privkey.pem
SSLCertificateChainFile /etc/letsencrypt/live/YOUR.DOMAIN.HERE/chain.pem
Include /etc/letsencrypt/options-ssl-apache.conf # The LetsEncrypt SSL config
Include /etc/apache2/conf-available/letsencrypt-proxypass-fix.conf # The patch for ProxyPass we made earlier

ProxyRequests Off
ProxyPreserveHost On
ProxyPass / http://000.000.000.000/ # Replace this with whatever address you had from your old config
ProxyPassReverse / http://000.000.000.000/

RequestHeader append &#34;X-Forwarded-Proto&#34; &#34;https&#34; # Tell the application we are forwarding from SSL
RequestHeader set &#34;X-Forwarded-Ssl&#34; &#34;on&#34;
<span style=color:#f92672>&lt;/VirtualHost&gt;</span>
</code></pre></div><p>Tada! Your service now uses your certificate. If you were to visit this site without Cloudflare&rsquo;s CDN you would be able to see that the site uses LetsEncrypt.</p><h2 id=configuring-cloudflare>Configuring Cloudflare</h2><p>Now that HTTPS is installed, we need to tell Cloudflare to use Full SSL. I personally have had mixed experiences, but sometimes if this isn&rsquo;t set properly, your browser can get stuck in a Redirect loop. Full SSL requires that your server has a certificate installed for users to access HTTPS via Cloudflare. Changing this option affects all records on the domain, so don&rsquo;t do this unless everything is set up correctly (alternativley you can use a <a href=https://support.cloudflare.com/hc/en-us/articles/200170536-How-do-I-redirect-all-visitors-to-HTTPS-SSL->Page Rule</a>). For a more detailed explanation, see <a href=https://support.cloudflare.com/hc/en-us/articles/200170416-What-do-the-SSL-options-mean->Cloudflare&rsquo;s support article</a>.</p><p>Once you are logged into Cloudflare&rsquo;s website, click your domain, click the <em>Crypto</em> button, and select <em>Full (Strict)</em> from the dropdown. Now Cloudflare will only use your valid LetsEncrypt Certificate for communication!</p><h2 id=wrap-up>Wrap Up</h2><p>If all went according to plan, you should be able to naivgate your site from inside or ourside Cloudflare via HTTPS. Make sure you update your site&rsquo;s links to use HTTPS!
Don&rsquo;t forget every month or so to renew the certificate you just made with <code>certbot renew</code>. I will make another post later on how to automatically renew your certs, eliminating the need for maintenance.</p><p>I hope this guide helped you. If you have any questions or comments, don&rsquo;t be afraid to comment or contact me!</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/2020-jumping-ship-dockerhub-quay/><span class=button__icon>←</span>
<span class=button__text>Jumping Ship: Migrating your container images from DockerHub to Quay.io</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>CC's Sink</span>
<span class=logo__cursor></span></a><div class=copyright><span>© 2020 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-36352435-4','auto');ga('send','pageview');}</script></body></html>